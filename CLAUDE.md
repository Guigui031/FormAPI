# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

FormAPI is a Flask-based REST API that handles contact form submissions via Gmail API. It supports OAuth2 authentication and can be deployed locally or via Docker.

## Key Architecture

### Authentication Flow
The application supports two authentication methods:
1. **Local Development**: Uses `token.json` generated by `src/setup_auth.py`
2. **Production**: Uses Google default credentials or service account via `GOOGLE_APPLICATION_CREDENTIALS`

The `get_gmail_credentials()` function in `src/app.py:26-47` handles credential management with fallback logic:
- First tries local `token.json`
- Falls back to `google.auth.default()` for production
- Attempts token refresh if expired

### Email Sending
The `send_form_email()` function in `src/app.py:49-97` constructs and sends emails using Gmail API:
- Formats form data into email body
- Sets Reply-To header to form submitter's email
- Returns Gmail message ID on success

### Environment Configuration
The app reads configuration from environment variables with fallback defaults:
- `SECRET_KEY`: Flask session secret
- `RECIPIENT_EMAIL`: Where form submissions are sent
- `SENDER_EMAIL`: Gmail account sending the emails
- `PRODUCTION_DOMAIN`: Used for OAuth redirect URI handling

Production domain detection affects OAuth redirect URIs (`src/app.py:172-175`).

## Development Commands

### Initial Setup
```bash
# Install dependencies
pip install -r requirements.txt

# Set up Gmail OAuth (required for local development)
python src/setup_auth.py
```

### Running the Application
```bash
# Development mode (with debug enabled)
python src/app.py

# Production mode with Gunicorn
gunicorn --bind 0.0.0.0:5000 --workers 4 src.app:app
```

### Docker Deployment
```bash
# Build and run with docker-compose
docker-compose up -d

# Manual Docker build
docker build -t formapi .
docker run -d -p 5000:5000 formapi
```

### Testing the API
```bash
# Health check
curl http://localhost:5000/health

# Test contact form submission
curl -X POST http://localhost:5000/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "subject": "Test Subject",
    "message": "Test message"
  }'
```

## Important Implementation Notes

### Gmail API Scopes
The app uses `gmail.send` scope only (`src/app.py:24`). If you need to add functionality that reads emails, you must update the SCOPES constant and re-authenticate.

### OAuth Redirect URI Handling
The app has special logic for production domain detection to handle HTTPS redirects correctly:
- Production: Forces `https://{PRODUCTION_DOMAIN}/auth/callback`
- Development: Uses `request.url_root + 'auth/callback'`

This logic appears in two places: `/auth` endpoint and `/auth/callback` endpoint.

### Docker Volume Mounting
The docker-compose.yml mounts `~/.config/gcloud` for user credentials. For service account authentication, uncomment the `credentials.json` volume mount and set `GOOGLE_APPLICATION_CREDENTIALS` appropriately.

## File Structure
- `src/app.py`: Main Flask application with all endpoints
- `src/setup_auth.py`: Local OAuth setup utility
- `requirements.txt`: Python dependencies
- `Dockerfile`: Production Docker image (uses Gunicorn)
- `docker-compose.yml`: Container orchestration
- `setup_service_account.md`: Documentation for service account setup
- `archives/`: Old test files (not actively used)

## API Endpoints

### POST /api/contact
Main endpoint for form submissions. Validates required fields: `name`, `email`, `subject`, `message`. Returns JSON with `success`, `message`, and `message_id` fields.

### GET /health
Health check endpoint returning `{"status": "healthy"}`.

### GET /auth
Initiates OAuth2 flow (primarily for initial setup).

### GET /auth/callback
OAuth2 callback handler that saves credentials to `token.json`.

### GET /debug-redirect
Debug endpoint showing OAuth redirect URI configuration.
